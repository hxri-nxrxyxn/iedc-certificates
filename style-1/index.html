<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Generator (from CSV)</title>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alegreya+Sans:ital,wght@0,100;0,300;0,400;0,500;0,700;0,800;0,900;1,100;1,300;1,400;1,500;1,700;1,800;1,900&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

    <style>
        html {
            box-sizing: border-box;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }

        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-size: 100%;
            background-color: white;
            min-height: 100vh;
            justify-content: center;
        }

        #controls,
        #certificate-container {
            display: none;
        }
        #drop-zone {
            display: flex;
        }

        #controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #controls button {
            width: auto;
            font-family: "Inter";
            font-weight: 700;
            font-size: 1.2rem;
            padding: 12px 64px;
            border-radius: 9999px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            color: #636e72;
            background-color: #ffeaa7 !important;
            border: 2px solid #636e72;
            transition: box-shadow ease 0.3s;
        }
        #controls button:hover {
            box-shadow: 0 0 5px rgba(0,0,0,0)
        }

        #certificate-container {
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding-bottom: 100px;
        }

        .certificate {
            position: relative;
            width: 800px;
            height: 565px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px 50px;
            text-align: center;
            overflow: hidden;
            transition: transform ease 0.3s;
        }

        .certificate:hover {
            border: 2px solid #636e72;
        }

        .certificate:nth-child(2n + 1):hover {
            transform: rotate(1deg);
        }

        .certificate:nth-child(2n + 2):hover {
            transform: rotate(-1deg);
        }

        .certificate-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .certificate h2 {
            font-size: 3em;
            color: #333;
            margin-top: 10px 0;
            transform: translateY(30px);
            font-family: 'Alegreya Sans';
            z-index: 1;
        }

        .certify-description {
            color: #3a3420;
            font-size: 1.5em;
            margin: 10px 0;
            font-family: 'Alegreya Sans';
            z-index: 1;
            line-height: 1.4;
            padding: 0 50px;
        }

        .certificate .qr-code {
            position: absolute;
            top: 160px;
            right: 80px;
            width: 100px;
            height: 100px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }
        .certificate .verification-key {
            position: absolute;
            opacity: 0.2;
            bottom: 10px;
            left: 280px;
            font-size: 0.8em;
            color: #666;
            z-index: 1;
        }

        #drop-zone {
            font-family: "Inter";
            font-weight: 700;
            text-transform: uppercase;
            background: #dfe6e9;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
            height: 200px;
            border: 3px dashed #636e72;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 2.1rem;
            color: #636e72;
            transition: all 0.3s ease;
            transform: rotate(2deg);
        }
        #drop-zone.drag-over {
            border-color: #007bff;
            background-color: #e7f3ff;
            color: #0056b3;
        }

        @media print {
            body {
                background: none;
                margin: 0;
                padding: 0;
                min-height: 0;
                justify-content: flex-start;
            }
            #controls, #drop-zone { display: none; }
            #certificate-container {
                display: block;
                padding-bottom: 0;
            }
            .certificate { page-break-after: always; border: none; box-shadow: none; margin: 0; width: 100%; height: auto; }
            .certificate-bg { display: none; }
        }
    </style>
</head>
<body>
    <div id="drop-zone"></div>

    <div id="controls">
        <button onclick="app.saveAndDownloadAll()" style="background-color: #28a745;">SAVE</button>
    </div>

    <div id="certificate-container"></div>

    <script>
        const app = (() => {
            // Configuration
            const CONFIG = {
                SUPABASE_URL: 'https://qgxtasbwavpotwiobzsb.supabase.co',
                SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFneHRhc2J3YXZwb3R3aW9ienNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NjUwMzYsImV4cCI6MjA3NzM0MTAzNn0.1b5NGOBIMrkHkueFJ6BIoG7Q5GNUi4SjUUUGe4vNWR4',
                REQUIRED_COLUMNS: ['student_name', 'role', 'batch', 'event_name', 'date'],
                MONTH_NAMES: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                DOWNLOAD_DELAY_MS: 300,
                CANVAS_SCALE: 2.5
            };

            // State
            let supabaseClient = null;
            let generatedDataForDB = [];

            // Initialize Supabase
            const initSupabase = () => {
                supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
            };

            // CSV Parsing
            const parseCSVLine = (line) => {
                const values = [];
                let inQuote = false;
                let currentValue = '';

                for (const char of line) {
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        values.push(currentValue);
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue);
                return values.map(v => v.trim().replace(/^"|"$/g, ''));
            };

            const parseCsvContent = (fileContent) => {
                const lines = fileContent.split(/\r?\n/);
                
                if (lines.length < 2) {
                    throw new Error('CSV needs a header and at least one data row.');
                }

                const headers = parseCSVLine(lines[0])
                    .map(h => h.trim().toLowerCase().replace(/"/g, ''));
                
                const hasRoleColumn = headers.includes('role');
                const data = {};
                
                CONFIG.REQUIRED_COLUMNS.forEach(col => {
                    data[col] = [];
                });

                const dataLines = lines.slice(1);
                let rowCount = 0;

                dataLines.forEach(line => {
                    if (line.trim() === '') return;
                    
                    rowCount++;
                    const values = parseCSVLine(line);
                    
                    headers.forEach((header, index) => {
                        if (data.hasOwnProperty(header)) {
                            data[header].push(values[index] || '');
                        }
                    });
                });

                if (!hasRoleColumn) {
                    data.role = Array(rowCount).fill('participant');
                }

                return data;
            };

            // Date Formatting
            const getDaySuffix = (day) => {
                const d = parseInt(day, 10);
                if (d > 3 && d < 21) return 'th';
                switch (d % 10) {
                    case 1: return 'st';
                    case 2: return 'nd';
                    case 3: return 'rd';
                    default: return 'th';
                }
            };

            const formatDbDate = (dateString) => {
                if (!dateString) return null;

                const ddMMyyyy = dateString.match(/^(\d{2})[-/](\d{2})[-/](\d{4})$/);
                if (ddMMyyyy) {
                    return `${ddMMyyyy[3]}-${ddMMyyyy[2]}-${ddMMyyyy[1]}`;
                }

                if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    return dateString;
                }

                console.warn(`Invalid date format for DB: ${dateString}`);
                return dateString;
            };

            const formatCertificateDate = (dateString) => {
                if (!dateString) return '';

                let day, monthIndex, year;

                const ddMMyyyy = dateString.match(/^(\d{2})[-/](\d{2})[-/](\d{4})$/);
                const yyyyMMdd = dateString.match(/^(\d{4})-(\d{2})-(\d{2})$/);

                if (ddMMyyyy) {
                    day = ddMMyyyy[1];
                    monthIndex = parseInt(ddMMyyyy[2], 10) - 1;
                    year = ddMMyyyy[3];
                } else if (yyyyMMdd) {
                    day = yyyyMMdd[3];
                    monthIndex = parseInt(yyyyMMdd[2], 10) - 1;
                    year = yyyyMMdd[1];
                } else {
                    console.warn(`Unparseable date for certificate: ${dateString}`);
                    return dateString;
                }

                if (monthIndex < 0 || monthIndex > 11) {
                    console.warn(`Invalid month in date: ${dateString}`);
                    return dateString;
                }

                return `${parseInt(day)}${getDaySuffix(day)} ${CONFIG.MONTH_NAMES[monthIndex]}, ${year}`;
            };

            // Certificate Generation
            const generateCertificateDescription = (role, eventText) => {
                const roleNormalized = (role || 'participant').toLowerCase();

                switch (roleNormalized) {
                    case 'first':
                        return `for securing <strong>First Prize</strong> ${eventText}`;
                    case 'second':
                        return `for securing <strong>Second Prize</strong> ${eventText}`;
                    case 'participant':
                        return `has actively participated ${eventText}`;
                    default:
                        return `for valuable contribution as a ${role} ${eventText}`;
                }
            };

            const generateUniqueKey = (name) => {
                const baseKey = name.replace(/\s+/g, '_').substring(0, 15);
                const timestamp = Date.now();
                const random = Math.floor(Math.random() * 1000);
                return `${baseKey}_${timestamp}_${random}`;
            };

            const createCertificateHtml = (details) => {
                const certificateDate = formatCertificateDate(details.date);
                const eventText = `in the workshop on ${details.event} held on ${certificateDate} organized by IEDC@SAINTGITS.`;
                const description = generateCertificateDescription(details.role, eventText);
                const uniqueKey = generateUniqueKey(details.name);

                const certificate = document.createElement('div');
                certificate.classList.add('certificate');

                certificate.innerHTML = `
                    <img class="certificate-bg" src="background.jpg" alt="Certificate Background">
                    <h2>${details.name}</h2>
                    <p class="certify-description">${description}</p>
                    <div class="qr-code" id="qrcode-${uniqueKey}"></div>
                    <p class="verification-key">Verification ID: ${uniqueKey}</p>
                `;

                const qrCodeContainer = certificate.querySelector(`#qrcode-${uniqueKey}`);
                new QRCode(qrCodeContainer, {
                    text: uniqueKey,
                    width: 75,
                    height: 75,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });

                const dataForDb = {
                    name: details.name,
                    event: details.event,
                    date: formatDbDate(details.date),
                    role: details.role,
                    batch: details.batch,
                    verification_key: uniqueKey
                };

                return { element: certificate, dataForDb };
            };

            const generateCertificates = (data) => {
                const container = document.getElementById('certificate-container');
                container.innerHTML = 'Generating certificates...';
                generatedDataForDB = [];

                const numCerts = data.student_name?.length || 0;
                
                if (numCerts === 0) {
                    showError('No data found in the file.');
                    return;
                }

                const certsToRender = [];
                for (let i = 0; i < numCerts; i++) {
                    const details = {
                        name: data.student_name[i],
                        role: data.role[i],
                        event: data.event_name[i],
                        date: data.date[i],
                        batch: data.batch[i]
                    };
                    
                    const { element, dataForDb } = createCertificateHtml(details);
                    certsToRender.push(element);
                    generatedDataForDB.push(dataForDb);
                }

                container.innerHTML = '';
                certsToRender.forEach(el => container.appendChild(el));
                console.log(`Generated ${certsToRender.length} certificates.`);
            };

            // Database Operations
            const saveCertificatesToDB = async (isSilent = false) => {
                if (generatedDataForDB.length === 0) {
                    if (!isSilent) alert('Please generate the certificates first before saving.');
                    return false;
                }

                console.log(`Attempting to save ${generatedDataForDB.length} records...`);
                let uploadErrors = 0;
                let duplicatesSkipped = 0;

                for (const dataForDb of generatedDataForDB) {
                    try {
                        const { error } = await supabaseClient
                            .from('certificates')
                            .insert(dataForDb);

                        if (error) {
                            if (error.code === '23505') {
                                console.log(`Duplicate found, skipping: ${dataForDb.name}`);
                                duplicatesSkipped++;
                            } else {
                                throw error;
                            }
                        } else {
                            console.log(`Successfully inserted: ${dataForDb.name}`);
                        }
                    } catch (error) {
                        uploadErrors++;
                        console.error(`Error saving ${dataForDb.name}:`, error.message);
                    }
                }

                if (uploadErrors > 0) {
                    console.error(`${uploadErrors} certificates failed to save.`);
                    if (!isSilent) {
                        alert(`${uploadErrors} certificates failed to save. Check console for errors.`);
                    }
                    return false;
                }

                const message = duplicatesSkipped > 0
                    ? `All new records saved successfully. ${duplicatesSkipped} duplicates were skipped.`
                    : 'All certificates successfully saved to the database!';
                
                console.log(message);
                if (!isSilent) alert(message);
                return true;
            };

            // Download Operations
            const downloadAllCertificates = async () => {
                const certificates = document.querySelectorAll('.certificate');
                
                if (certificates.length === 0) {
                    alert('Please generate certificates first.');
                    return;
                }

                for (const cert of certificates) {
                    const canvas = await html2canvas(cert, {
                        scale: CONFIG.CANVAS_SCALE,
                        willReadFrequently: true
                    });

                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = image;
                    
                    const name = cert.querySelector('h2').textContent.replace(/\s+/g, '_');
                    link.download = `Certificate_${name}.png`;

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    await new Promise(resolve => setTimeout(resolve, CONFIG.DOWNLOAD_DELAY_MS));
                }
            };

            const saveAndDownloadAll = async () => {
                if (generatedDataForDB.length === 0) {
                    alert('No certificates were generated. Please drop a file first.');
                    return;
                }

                console.log('Attempting to save to database first...');
                const saveSuccess = await saveCertificatesToDB(true);

                if (saveSuccess) {
                    console.log('Database save successful. Proceeding to download.');
                    await downloadAllCertificates();
                } else {
                    alert('Saving to database failed. Download has been cancelled. Please check the console for errors.');
                }
            };

            // UI Operations
            const showError = (message) => {
                alert(`Error: ${message}`);
                const container = document.getElementById('certificate-container');
                const dropZone = document.getElementById('drop-zone');
                const controls = document.getElementById('controls');
                
                container.innerHTML = '';
                dropZone.style.display = 'flex';
                dropZone.textContent = 'Error. Please try a different file.';
                controls.style.display = 'none';
                document.body.style.justifyContent = 'center';
            };

            const showCertificates = () => {
                document.body.style.justifyContent = 'flex-start';
                document.getElementById('drop-zone').style.display = 'none';
                document.getElementById('controls').style.display = 'block';
                document.getElementById('certificate-container').style.display = 'flex';
            };

            // Event Handlers
            const handleDragOver = (event) => {
                event.preventDefault();
                event.currentTarget.classList.add('drag-over');
            };

            const handleDragLeave = (event) => {
                event.currentTarget.classList.remove('drag-over');
            };

            const handleDrop = async (event) => {
                event.preventDefault();
                const dropZone = event.currentTarget;
                dropZone.classList.remove('drag-over');

                const files = event.dataTransfer.files;

                if (files.length === 0) return;

                const file = files[0];
                
                if (!file.name.endsWith('.csv') && file.type !== 'text/csv') {
                    alert('Error: Please drop a .csv file.');
                    return;
                }

                dropZone.textContent = `Processing "${file.name}"...`;

                try {
                    const fileContent = await file.text();
                    const data = parseCsvContent(fileContent);
                    generateCertificates(data);
                    showCertificates();
                } catch (err) {
                    console.error('Error processing file:', err);
                    alert(`An error occurred while reading the file: ${err.message}`);
                    dropZone.textContent = 'Drag & Drop your .csv file here';
                }
            };

            // Initialization
            const init = () => {
                initSupabase();
                
                const dropZone = document.getElementById('drop-zone');
                dropZone.textContent = 'DROP';
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('dragleave', handleDragLeave);
                dropZone.addEventListener('drop', handleDrop);
            };

            // Public API
            return {
                init,
                saveAndDownloadAll
            };
        })();

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
